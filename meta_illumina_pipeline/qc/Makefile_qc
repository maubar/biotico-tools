#Make parameters
SHELL := /bin/bash

R1:= $(wildcard reads/*R1*.fastq.gz)
R2:= $(wildcard reads/*R2*.fastq.gz)

output_basename := P431_102_QC

#Logging
log_file := $(output_basename)_$(shell date +%s).log
write_to_log := >( tee -a $(log_file) >&2 )

#Run params
threads:=16
adaptor_file:= adapters/truseq_custom.fa
TRIMMOMATIC:= java -jar /labcommon/tools/Trimmomatic-0.32/trimmomatic-0.32.jar

#Output basenames
nesoni_1 := nesoni_def
nesoni_2 := nesoni_custom
nesoni_3 := nesoni_match15mm2
nesoni_4 := nesoni_match15mm2_truseqht

trimmy_1 := trimmy
trimmy_nesoni := nesoni_noclip_trimmy

prinseq := prinseq_1

#Delete produced files if step fails
.DELETE_ON_ERROR:

#.SECONDARY: $(nesoni_1)_R1.fq.gz $(nesoni_2)_R1.fq.gz $(nesoni_3)_R1.fq.gz $(nesoni_4)_R1.fq.gz
.SECONDARY: $(nesoni_3)_R1.fq.gz $(nesoni_4)_R1.fq.gz $(trimmy_1)_R1.fq.gz $(trimmy_nesoni)_R1.fq.gz

# all: $(nesoni_1)_R1.fq_fastqc.zip $(nesoni_2)_R1.fq_fastqc.zip $(nesoni_3)_R1.fq_fastqc.zip $(nesoni_4)_R1.fq_fastqc.zip $(trimmy_1)_R1.fq_fastqc.zip
all: $(trimmy_nesoni)_R1.fq_fastqc.zip $(trimmy_nesoni)_R2.fq_fastqc.zip

$(nesoni_1)_R%.fq.gz: $(R1) $(R2)
	nesoni clip --length 75 --out-separate yes $(nesoni_1) pairs: $^ 2> $(write_to_log)

$(nesoni_2)_R%.fq.gz: $(R1) $(R2)
	nesoni clip --adaptor-file $(adaptor_file) --length 75 --out-separate yes $(nesoni_2) pairs: $^ 2> $(write_to_log)

$(nesoni_3)_R%.fq.gz: $(R1) $(R2)
	nesoni clip --match 15 --max-errors 2 --length 75 --out-separate yes $(nesoni_3) pairs: $^ 2> $(write_to_log)

$(nesoni_4)_R%.fq.gz: $(R1) $(R2)
	nesoni clip --adaptor-file $(adaptor_file) --match 15 --max-errors 2 --length 75 --out-separate yes $(nesoni_4) pairs: $^ 2> $(write_to_log)

$(trimmy_1)_R%.fq.gz: $(R1) $(R2)
	$(TRIMMOMATIC) PE -threads 16 -phred33 -trimlog trimmomatic.log $^ $(trimmy_1)_R1.fq.gz $(trimmy_1)_singleR1.fq.gz $(trimmy_1)_R2.fq.gz $(trimmy_1)_singleR2.fq.gz ILLUMINACLIP:$(adaptor_file):2:30:10 MINLEN:75 2> $(write_to_log)

$(trimmy_nesoni)_R%.fq.gz: $(R1) $(R2)
	nesoni clip --adaptor-clip no --homopolymers yes --quality 20 --length 75 --out-separate yes nesoni_temp pairs: $^ 2> $(write_to_log)
	$(TRIMMOMATIC) PE -threads 16 -phred33 -trimlog trimmomatic.log nesoni_temp_R1.fq.gz nesoni_temp_R2.fq.gz $(trimmy_nesoni)_R1.fq.gz $(trimmy_nesoni)_singleR1.fq.gz $(trimmy_nesoni)_R2.fq.gz $(trimmy_nesoni)_singleR2.fq.gz ILLUMINACLIP:$(adaptor_file):2:30:10 MINLEN:75 2> $(write_to_log)
	-rm nesoni_temp*

#prinseq-lite.pl -fastq $R1 -fastq2 $R2 -params prinseq_params.txt

#Run fastqc with kmer 10
%.fq_fastqc.zip: %.fq.gz
	fastqc --noextract -k 10 $^

%.fq_fastqc.zip: %.fq
	fastqc --noextract -k 10 $^

#Run SGA preqc
raw_reads.preqc: $(R1) $(R2)
	sga preprocess --pe-mode 1 $^ > raw_reads.fastq
	sga index -a ropebwt --no-reverse -t 8 raw_reads.fastq
	sga preqc -t 8 raw_reads.fastq > raw_reads.preqc
	sga-preqc-report.py raw_reads.preqc 

qual_trimmed.preqc: $(trimmy_nesoni)_R1.fq.gz $(trimmy_nesoni)_R2.fq.gz
	sga preprocess --pe-mode 1 $^ > qual_trimmed.fastq
	sga index -a ropebwt --no-reverse -t 8 qual_trimmed.fastq
	sga preqc -t 8 qual_trimmed.fastq > qual_trimmed.preqc
	sga-preqc-report.py qual_trimmed.preqc

#Run Jellyfish 17-mer
%.k17.hist: %.fq
	mkdir -p $*_jellyfish_17mer
	jellyfish count -s 8G -C -m 17 -t 16 -o $*_jellyfish_17mer/k17 $^
	cd $*_jellyfish_17mer && jellyfish merge -o k17.jf k17_*
	jellyfish histo -t 16 -f $*_jellyfish_17mer/k17.jf > $*.k17.hist

%.k31.hist: %.fq
	mkdir -p $*_jellyfish_31mer
	jellyfish count -s 8G -C -m 31 -t 16 -o $*_jellyfish_31mer/k31 $^
	cd $*_jellyfish_31mer && jellyfish merge -o k31.jf k31_*
	jellyfish histo -t 16 -f $*_jellyfish_31mer/k31.jf > $*.k31.hist

.PHONY: clean
clean:
	-rm *.fq.gz 
	-rm *.fq_fastqc.zip #Fastqc
	-rm *.log #Makefile log
	-rm *.log.txt #Nesoni log